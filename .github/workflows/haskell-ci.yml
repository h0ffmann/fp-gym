# .github/workflows/haskell-ci.yml
name: Haskell CI

on:
  push:
    branches: [ main ]
    paths:
      - 'haskell/**'
      - '.github/workflows/haskell-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'haskell/**'
      - '.github/workflows/haskell-ci.yml'

env:
  # Cache key for Haskell dependencies
  HASKELL_CACHE_KEY: ${{ runner.os }}-stack-${{ hashFiles('**/stack.yaml', '**/stack.yaml.lock', '**/*.cabal') }}

jobs:
  # ============================================
  # HASKELL BUILD & TEST MATRIX
  # ============================================
  haskell-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        ghc-version: ['9.6.6']
        include:
          - ghc-version: '9.6.6'
            stack-yaml: 'stack.yaml'
    
    name: Haskell (GHC ${{ matrix.ghc-version }})
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Haskell Stack
      uses: haskell-actions/setup@v2
      with:
        ghc-version: ${{ matrix.ghc-version }}
        enable-stack: true
        stack-version: 'latest'

    - name: Cache Stack dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.stack
          haskell/.stack-work
        key: ${{ env.HASKELL_CACHE_KEY }}-${{ matrix.ghc-version }}
        restore-keys: |
          ${{ env.HASKELL_CACHE_KEY }}-
          ${{ runner.os }}-stack-

    - name: Check if Haskell project exists
      id: check-haskell
      run: |
        if [ -f "haskell/stack.yaml" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Bootstrap Haskell environment (if needed)
      if: steps.check-haskell.outputs.exists == 'false'
      run: |
        if [ -f "bootstrap-haskell-fixed.sh" ]; then
          chmod +x bootstrap-haskell-fixed.sh
          ./bootstrap-haskell-fixed.sh
        elif [ -f "setup-haskell-tooling.sh" ]; then
          chmod +x setup-haskell-tooling.sh
          ./setup-haskell-tooling.sh
        else
          echo "‚ùå No Haskell bootstrap script found"
          exit 1
        fi

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libffi-dev libffi8ubuntu1 libgmp-dev libgmp10 libncurses-dev

    - name: Setup GHC and Stack
      working-directory: haskell
      run: |
        stack setup --resolver ghc-${{ matrix.ghc-version }}
        stack --version
        stack ghc -- --version

    - name: Install dependencies
      working-directory: haskell
      run: |
        stack build --resolver ghc-${{ matrix.ghc-version }} --dependencies-only
      
    - name: Build Haskell project
      working-directory: haskell
      run: |
        stack build --resolver ghc-${{ matrix.ghc-version }}
      
    - name: Run Haskell tests
      working-directory: haskell
      run: |
        stack test --resolver ghc-${{ matrix.ghc-version }}
      
    - name: Run unit tests specifically
      working-directory: haskell
      run: |
        echo "üß™ Running unit tests..."
        stack test --resolver ghc-${{ matrix.ghc-version }} --test-arguments="--match='TwoSumSpec'"
      
    - name: Run property tests specifically
      working-directory: haskell
      run: |
        echo "üß™ Running property tests..."
        stack test --resolver ghc-${{ matrix.ghc-version }} --test-arguments="--match='Properties'" || echo "‚ö†Ô∏è Property tests not yet implemented"
      
    - name: Generate test coverage
      working-directory: haskell
      run: |
        echo "üìä Generating test coverage..."
        stack test --resolver ghc-${{ matrix.ghc-version }} --coverage || echo "‚ö†Ô∏è Coverage generation failed"
      
    - name: Check code formatting (if formatter available)
      working-directory: haskell
      run: |
        if stack exec --resolver ghc-${{ matrix.ghc-version }} -- which fourmolu >/dev/null 2>&1; then
          echo "üìù Checking Haskell code formatting..."
          find src test app bench -name "*.hs" -exec stack exec --resolver ghc-${{ matrix.ghc-version }} -- fourmolu --mode check {} \; || echo "‚ö†Ô∏è Formatting issues found"
        elif stack exec --resolver ghc-${{ matrix.ghc-version }} -- which ormolu >/dev/null 2>&1; then
          echo "üìù Checking Haskell code formatting..."
          find src test app bench -name "*.hs" -exec stack exec --resolver ghc-${{ matrix.ghc-version }} -- ormolu --mode check {} \; || echo "‚ö†Ô∏è Formatting issues found"
        else
          echo "‚ö†Ô∏è No formatter available, skipping format check"
        fi
      
    - name: Run hlint (if available)
      working-directory: haskell
      run: |
        if stack exec --resolver ghc-${{ matrix.ghc-version }} -- which hlint >/dev/null 2>&1; then
          echo "üîç Running hlint..."
          stack exec --resolver ghc-${{ matrix.ghc-version }} -- hlint src test app bench || echo "‚ö†Ô∏è Hlint suggestions found"
        else
          echo "‚ö†Ô∏è Hlint not available, skipping lint check"
        fi
      
    - name: Generate Haddock documentation
      working-directory: haskell
      run: |
        echo "üìö Generating documentation..."
        stack haddock --resolver ghc-${{ matrix.ghc-version }} || echo "‚ö†Ô∏è Documentation generation failed"
      if: matrix.ghc-version == '9.6.6'  # Only generate docs for latest GHC
      
    - name: Test executable
      working-directory: haskell
      run: |
        echo "üéØ Testing executable..."
        stack exec --resolver ghc-${{ matrix.ghc-version }} fp-gym-haskell-exe || echo "‚ö†Ô∏è Executable test failed"
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: haskell-test-results-ghc-${{ matrix.ghc-version }}
        path: |
          haskell/.stack-work/logs/
          haskell/.stack-work/dist/*/doc/
          haskell/.stack-work/install/*/doc/
        retention-days: 30
          
    - name: Haskell Test Summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Haskell tests passed on GHC ${{ matrix.ghc-version }}!"
        else
          echo "‚ùå Haskell tests failed on GHC ${{ matrix.ghc-version }}. Check the logs above."
        fi

  # ============================================
  # HASKELL BENCHMARKS (Optional)
  # ============================================
  haskell-benchmarks:
    needs: haskell-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    name: Haskell Benchmarks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Haskell Stack
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.6.6'
        enable-stack: true
        stack-version: 'latest'

    - name: Cache Stack dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.stack
          haskell/.stack-work
        key: ${{ env.HASKELL_CACHE_KEY }}-9.6.6-bench
        restore-keys: |
          ${{ env.HASKELL_CACHE_KEY }}-9.6.6-
          ${{ env.HASKELL_CACHE_KEY }}-

    - name: Setup and build
      working-directory: haskell
      run: |
        stack setup
        stack build --dependencies-only
        stack build

    - name: Run benchmarks
      working-directory: haskell
      run: |
        echo "üèÉ Running Haskell benchmarks..."
        stack bench --benchmark-arguments="--output benchmark-results.html" || echo "‚ö†Ô∏è Benchmarks failed or not implemented"

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: haskell-benchmark-results
        path: |
          haskell/benchmark-results.html
          haskell/.stack-work/dist/*/bench/
        retention-days: 30

  # ============================================
  # INTEGRATION WITH MAIN CI
  # ============================================
  haskell-status:
    needs: [haskell-test]
    if: always()
    runs-on: ubuntu-latest
    
    name: Haskell CI Status
    
    steps:
    - name: Check Haskell CI status
      run: |
        echo "üìä Haskell CI Results:"
        echo "====================="
        
        if [ "${{ needs.haskell-test.result }}" == "success" ]; then
          echo "‚úÖ Haskell tests: PASSED"
        else
          echo "‚ùå Haskell tests: FAILED"
          OVERALL_FAILED=true
        fi
        
        echo "====================="
        
        if [ "$OVERALL_FAILED" == "true" ]; then
          echo "‚ùå Haskell CI FAILED"
          exit 1
        else
          echo "‚úÖ Haskell CI PASSED"
          echo "üéâ All Haskell checks completed successfully!"
        fi
